"use strict";function renderApp(){showStudents(),showGroups(),showTasks(),showMentors()}function showStudents(){$(".students__list").empty().append('<div class="groups__list"></div>'),students.length?students.forEach(function(t){t.name&&!t.groupId&&createStudentElem(t.name)}):$(".students__list").append('\n    <div class="students__no-items">\n      <div><i class="fa fa-4x fa-arrow-circle-up"></i></div>\n      <p style="font-size: 14px;">Как ни крути, а без студентов ничего не выйдет. Добавьте парочку...</p>\n    </div>\n  ')}function showGroups(){groups.forEach(function(t){t.name&&createGroupElem(t.name)})}function showMentors(){$(".mentors__list").empty(),mentors.length?mentors.forEach(function(t){t.name&&createMentorElem(t.name)}):$(".mentors__list").append('\n    <div class="mentors__no-items">\n      <div><i class="fa fa-4x fa-arrow-circle-up"></i></div>\n      <p style="font-size: 14px;">Как ни крути, а без менторов ничего не выйдет. Добавьте парочку...</p>\n    </div>\n  ')}function showTasks(){return $(".tasks__list").empty(),tasks.length?void tasks.forEach(function(t){if(t.name){var s=void 0,e=void 0;t.groupId?(s=t.groupId,e=!0):s=t.studentId,createTaskElem(t.name,t.details,s,e,t.rating)}}):($(".tasks__list").append('<div class="tasks__no-items">Задания пока не назначены</div>'),!1)}function createGroupElem(t){var s="";getElemOfObject(groups,getIdByName(t,groups)).studentsId.forEach(function(t){var e=getElemOfObject(students,t);s+='\n      <div class="students__name" data-id="'+e.id+'">\n        <span>'+e.name+'</span>\n        <div class="students__button students__delete-button" title="Удалить студента"><i class="fa fa-trash"></i></div>\n        <div class="students__button students__expel-button" title="Исключить из группы"><i class="fa fa-user-times"></i></div>\n        <div class="students__button students__show-wishlist-button" title="Открыть список приоритетов"><i class="fa fa-list"></i></div>\n      </div>\n      '}),s.length||(s="<div class='students__no-items'>В группе нет студентов<div>"),$(".groups__list").append("\n    <div data-id='"+getIdByName(t,groups)+"' class='groups__item'>\n      <h5 class=\"groups__item-name\">\n        <span>"+t+'</span>\n        <div class="students__button students__delete-group-button" title="Удалить группу"><i class="fa fa-trash"></i></div>\n        <div class="students__button students__expel-all-button" title="Исключить всех"><i class="fa fa-times"></i></div>\n        <div class="students__button students__add-task-button" title="Создать задачу"><i class="fa fa-file"></i></div>\n      </h5>\n      '+s+"\n    </div>\n  ")}function createTaskElem(t,s,e,n,i){var a=void 0;a=n?getNameById(e,groups):getNameById(e,students),$(".tasks__list").append("\n    <div data-id='"+getIdByName(t,tasks)+"' class='tasks__task-item'>\n      <div class=\"tasks__task-item-name\"><span>"+t+'</span></div>\n      <div class="tasks__task-item-details"><span>'+s+'</span></div>\n      <div class="tasks__task-item-author">Автор: <span>'+a+'</span></div>\n      <div class="tasks__task-item-rating" data-type="task">\n        '+createRatingElem(i,5)+'\n      </div>\n      <div class="tasks__task-delete-button"><i class="fa fa-times"></i></div>\n    <div>\n  ')}function createRatingElem(t,s){for(var e="",n=1;s+1>n;n++)e+=t>=n?'<i class="fa fa-star" data-value="'+n+'"></i>':'<i class="fa fa-star-o" data-value="'+n+'"></i>';return e}function createStudentElem(t){$(".students__list").append("\n    <div data-id='"+getIdByName(t,students)+"' class='students__name'>\n      <span>"+t+'</span>\n      <div class="students__button students__delete-button" title="Удалить студента"><i class="fa fa-trash"></i></div>\n      <div class="students__button students__add-to-group-button" title="Добавить в группу..."><i class="fa fa-plus"></i></div>\n      <div class="students__button students__add-task-button" title="Создать задачу"><i class="fa fa-file"></i></div>\n      <div class="students__button students__show-wishlist-button" title="Открыть список приоритетов"><i class="fa fa-list"></i></div>\n    </div>\n  ')}function createMentorElem(t){$(".mentors__list").append("\n    <div data-id='"+getIdByName(t,mentors)+"' class='mentors__name'>\n      <span>"+t+'</span>\n      <div class="mentors__button mentors__delete-button" title="Удалить ментора"><i class="fa fa-trash"></i></div>\n      <div class="mentors__button mentors__show-wishlist-button" title="Открыть список приоритетов"><i class="fa fa-list"></i></div>\n    </div>\n  ')}function onDistributionButtonClick(){var t="";$(".distribution__list").empty(),collectSynergy(),sortStudents(),mentors.forEach(function(s){var e="",n="";s.list.forEach(function(t){e+='<li class="distribution__item-list-element">'+getNameById(t,students)+"</li>"}),n+='\n    <div class="distribution__item">\n        <div class="distribution__item-title">'+s.name+'</div>\n        <div class="distribution__item-list">\n            <ul>'+e+"</ul>\n        </div>\n    </div>\n    ",t+=n}),$(".distribution__list").append(t),$(".distribution").show()}function onShowWishListClick(t){var s=$(this).parent(".students__name").text().trim(),e=$(this).parent(".mentors__name").text().trim(),n=$(this).parent(".students__name").data("id"),i=$(this).parent(".mentors__name").data("id"),a="";if(s){$(".wishlist__title").text(s);var o=getElemOfObject(students,n);o.wishList.forEach(function(t){a+='\n        <div class="wishlist__element" data-id="'+t.mentorId+'">\n          <div class="wishlist__element-name">'+getNameById(t.mentorId,mentors)+'</div>\n          <div class="wishlist__priority" data-type="mentor">'+createRatingElem(t.priority,10)+"</div>\n        </div>\n      "}),$(".wishlist__list").empty().append(a),$(".wishlist").css({top:t.pageY,left:t.pageX-$(".wishlist").width()-20}).fadeIn(50)}if(e){$(".wishlist__title").text(e);var r=getElemOfObject(mentors,i);r.wishList.forEach(function(t){a+='\n        <div class="wishlist__element" data-id="'+t.studentId+'">\n          <div class="wishlist__element-name">'+getNameById(t.studentId,students)+'</div>\n          <div class="wishlist__priority" data-type="student">'+createRatingElem(t.priority,10)+"</div>\n        </div>\n      "}),$(".wishlist__list").empty().append(a),$(".wishlist").css({top:t.pageY,left:t.pageX-$(".wishlist").width()-20}).fadeIn(50)}}function onHoverRating(){$(this).prevAll().andSelf().addClass("fa-star").removeClass("fa-star-o"),$(this).nextAll().removeClass("fa-star").addClass("fa-star-o")}function onLeavingRating(){var t=$(this).data("type"),s=void 0;if("task"==t){var e=$(this).closest(".tasks__task-item").data("id");s=getTaskRating(e)}else if("student"==t){var n=getIdByName($(this).closest(".wishlist").find(".wishlist__title").text().trim(),mentors),i=$(this).parent().data("id");s=getPriorityOfStudent(i,n)}else if("mentor"==t){var a=getIdByName($(this).closest(".wishlist").find(".wishlist__title").text().trim(),students),o=$(this).parent().data("id");s=getPriorityOfMentor(o,a)}0===s?$(this).children().addClass("fa-star-o").removeClass("fa-star"):$(this).children().each(function(t,e){Number(e.dataset.value)===s&&($(e).prevAll().andSelf().addClass("fa-star").removeClass("fa-star-o"),$(e).nextAll().addClass("fa-star-o").removeClass("fa-star"))})}function onRatingClick(){var t=$(this).data("value"),s=$(this).parent().data("type");if("task"==s){var e=$(this).closest(".tasks__task-item").data("id");setTaskRating(e,t)}else if("student"==s){var n=$(this).closest(".wishlist__element").data("id"),i=getIdByName($(this).closest(".wishlist").find(".wishlist__title").text().trim(),mentors);setStudentPriority(n,i,t)}else if("mentor"==s){var a=$(this).closest(".wishlist__element").data("id"),o=getIdByName($(this).closest(".wishlist").find(".wishlist__title").text().trim(),students);setMentorPriority(a,o,t)}}function onClearAllClick(){clearAll(),renderApp()}function onMouseDown(t){var s=$(".students__group-list"),e=$(".wishlist"),n=$(".distribution"),i=[].concat(s,e,n);i.forEach(function(s){s.is(t.target)||0!=s.has(t.target).length||s.fadeOut(200)})}function onMentorTitleClick(){$(".mentors__title").addClass("mentors__title_active"),$(".mentors").show(),$(".students__title").removeClass("students__title_active"),$(".students").hide()}function onStudentTitleClick(){$(".students__title").addClass("students__title_active"),$(".students").show(),$(".mentors__title").removeClass("mentors__title_active"),$(".mentors").hide()}function onGroupEditClick(){var t=$('<input type="text">'),s=$(this),e=getIdByName(s.text(),groups);editElement(t,s,groups,e,"name")}function onTaskEditClick(){var t=$('<input type="text">'),s=$(this),e=getIdByName(s.text(),tasks);editElement(t,s,tasks,e,"name")}function onTaskDetailEditClick(){var t=$('<textarea class="form-control" rows="6"></textarea>'),s=$(this),e=s.parent().data("id");editElement(t,s,tasks,e,"details")}function onStudentEditClick(){var t=$('<input type="text" class="form-control">'),s=$(this),e=s.parent().data("id");editElement(t,s,students,e,"name")}function onMentorEditClick(){var t=$('<input type="text" class="form-control">'),s=$(this),e=s.parent().data("id");editElement(t,s,mentors,e,"name")}function editElement(t,s,e,n,i){var a=s.text();s.hide(),s.before(t),t.val(s.text()),t.focus(),t.blur(function(){""===t.val()?s.text(a):s.text(t.val()),changeValueOfObject(i,e,n,s.text()),t.remove(),s.show()})}function onTaskAddClick(){var t=$(this).closest(".students__name").data("id"),s=$(this).closest(".groups__item").data("id");t&&addTask("Индивидуальное задание "+(tasks.counter+1),"Описание индивидуального задания...",t,!1),s&&addTask("Групповое задание "+(tasks.counter+1),"Описание группового задания...",s,!0),showTasks()}function onTaskDeleteClick(){var t=$(this).closest(".tasks__task-item").find(".tasks__task-item-name").text().trim(),s=getIdByName(t,tasks);deleteTask(s),renderApp()}function onGroupDeleteClick(){var t=$(this).parents(".groups__item").data("id");dismissGroup(t),deleteGroup(t),renderApp()}function onGroupExpellAllClick(){var t=$(this).parents(".groups__item").data("id");dismissGroup(t),renderApp()}function onStudentExpelClick(){var t=$(this).closest(".students__name").data("id"),s=$(this).closest(".groups__item").data("id");expelStudentFromGroup(t,s),renderApp()}function onAddGroupMenuClick(){var t=$(this).text(),s=$(this).closest(".students__name").data("id");addStudentToGroup(s,getIdByName(t,groups)),renderApp()}function onAddGroupBtnClick(){var t=$(this).closest(".students__name").data("id"),s="Группа "+(groups.counter+1);addGroup(s),addStudentToGroup(t,getIdByName(s,groups)),renderApp()}function onStudentAddToGroupClick(){var t=$(this).parent(),s=getNamesFrom(groups),e="";s.forEach(function(t){e+='\n      <div class="students__group-menu-button label label-default">'+t+"</div>\n    "}),t.append('\n    <div class="students__group-list">\n      '+e+'\n      <div class="students__new-group label label-success">Новая группа</div>\n    </div>\n  ')}function onStudentAddClick(){var t=$(".students__input").val();if(t){if(-1!==getNamesFrom(students).indexOf(t))return $(".students .input-group").addClass("has-error"),$(".students__input-error").text("Такое имя уже есть"),!1;$(".students .input-group").removeClass("has-error"),$(".students__input-error").text(""),addStudent(t),renderApp(),$(".students__input").val("")}else $(".students__input-error").text("Не введено имя!"),$(".students .input-group").addClass("has-error")}function onMentorAddClick(){var t=$(".mentors__input").val();if(t){if(-1!==getNamesFrom(mentors).indexOf(t))return $(".mentors .input-group").addClass("has-error"),$(".mentors__input-error").text("Такое имя уже есть"),!1;$(".mentors .input-group").removeClass("has-error"),$(".mentors__input-error").text(""),addMentor(t),renderApp(),$(".mentors__input").val("")}else $(".mentors__input-error").text("Не введено имя!"),$(".mentors .input-group").addClass("has-error")}function onStudentDeleteClick(){var t=$(this).parent().data("id"),s=confirm("Действительно удалить "+getNameById(t,students)+"?\nЭто также удалит все связанные со студентом задания!");s&&($(this).parent().remove(),deleteStudent(t),renderApp())}function onMentorDeleteClick(){var t=$(this).parent().data("id"),s=confirm("Действительно удалить "+getNameById(t,mentors)+"?");s&&($(this).parent().remove(),deleteMentor(t),renderApp())}function exportJSON(){var t={students:students,groups:groups,mentors:mentors,tasks:tasks},s=JSON.stringify(t);$(this).parent().find("textarea").val(s).toggle()}function readFromJson(t){var s=new XMLHttpRequest;return s.open("GET",t,!1),s.send(),200!=s.status?(alert(s.status+": "+s.statusText),!1):JSON.parse(s.responseText)}function getElemOfObject(t,s){return t.filter(function(t){return t.id===Number(s)})[0]}function getNamesFrom(t){return t.reduce(function(t,s){return t.concat(s.name)},[])}function getIdByName(t,s){return s.filter(function(s){return s.name===t})[0].id}function getNameById(t,s){return s.filter(function(s){return s.id===Number(t)})[0].name}function addMentor(t){mentors.push({id:mentors.counter+1,name:t,list:[],wishList:[]}),students.forEach(function(t){t.name&&(t.wishList.push({mentorId:mentors.counter+1,priority:0}),getElemOfObject(mentors,mentors.counter+1).wishList.push({studentId:t.id,priority:0,synergy:0}))}),mentors.counter++}function deleteMentor(t){mentors.forEach(function(s,e){s.id===Number(t)&&mentors.splice(e,1)}),students.forEach(function(s){s.wishList.forEach(function(e,n){e.mentorId===t&&s.wishList.splice(n,1)})})}function addStudent(t){students.push({id:students.counter+1,name:t,groupId:0,tasksId:[],wishList:[]}),mentors.forEach(function(t){t.name&&(t.wishList.push({studentId:students.counter+1,priority:0,synergy:0}),getElemOfObject(students,students.counter+1).wishList.push({mentorId:t.id,priority:0}))}),students.counter++}function deleteStudent(t){students.forEach(function(s,e){if(s.id===Number(t)){var n=s.tasksId;n.forEach(function(t){return deleteTask(t)}),students.splice(e,1)}}),groups.forEach(function(s){var e=s.studentsId.indexOf(t);-1!==e&&s.studentsId.splice(e,1)}),mentors.forEach(function(s){s.wishList.forEach(function(e,n){e.studentId===t&&s.wishList.splice(n,1)})})}function addGroup(t){groups.push({id:groups.counter+1,name:t,studentsId:[],tasksId:[]}),groups.counter++}function deleteGroup(t){groups.forEach(function(s,e){if(s.id===Number(t)){var n=s.tasksId;n.forEach(function(t){return deleteTask(t)}),groups.splice(e,1)}})}function dismissGroup(t){var s=getElemOfObject(groups,t);s.studentsId.forEach(function(t){getElemOfObject(students,t).groupId=0}),s.studentsId=[]}function addStudentToGroup(t,s){var e=getElemOfObject(groups,s),n=getElemOfObject(students,t);e.studentsId.push(t),n.groupId=s}function expelStudentFromGroup(t,s){var e=getElemOfObject(groups,s),n=getElemOfObject(students,t);e.studentsId=e.studentsId.filter(function(s){return s!==t}),n.groupId=0}function addTask(t,s,e,n){tasks.push({id:tasks.counter+1,name:t,details:s,rating:0,studentId:0,groupId:0});var i=getElemOfObject(tasks,tasks.counter+1);n?(i.groupId=e,getElemOfObject(groups,e).tasksId.push(i.id)):(i.studentId=e,getElemOfObject(students,e).tasksId.push(i.id)),tasks.counter++}function deleteTask(t){tasks.forEach(function(s,e){s.id===Number(t)&&tasks.splice(e,1)})}function getTaskRating(t){return tasks.filter(function(s){return s.id===Number(t)})[0].rating}function setTaskRating(t,s){getElemOfObject(tasks,t).rating=s}function changeValueOfObject(t,s,e,n){getElemOfObject(s,e)[t]=n}function getWishlistOf(t,s){return getElemOfObject(t,s).wishList}function getPriorityOfMentor(t,s){var e=getWishlistOf(students,s);return e.filter(function(s){return s.mentorId===Number(t)})[0].priority}function setMentorPriority(t,s,e){var n=getElemOfObject(students,s).wishList;n.forEach(function(s){s.mentorId===Number(t)&&(s.priority=e)})}function getPriorityOfStudent(t,s){var e=getElemOfObject(mentors,s).wishList;return e.filter(function(s){return s.studentId===Number(t)})[0].priority}function setStudentPriority(t,s,e){var n=getElemOfObject(mentors,s).wishList;n.forEach(function(s){s.studentId===Number(t)&&(s.priority=e)})}function collectSynergy(){mentors.forEach(function(t){if(t.id){var s=getWishlistOf(mentors,t.id);s.forEach(function(s){s.synergy=s.priority+getPriorityOfMentor(t.id,s.studentId)})}})}function setRandPriority(){mentors.forEach(function(t){t.name&&(t.wishList=[],students.forEach(function(s){s.name&&t.wishList.push({studentId:s.id,priority:Math.floor(10*Math.random())+1})}))}),students.forEach(function(t){t.name&&(t.wishList=[],mentors.forEach(function(s){s.name&&t.wishList.push({mentorId:s.id,priority:Math.floor(10*Math.random())+1})}))}),alert("Priorities have been set")}function sortStudents(){mentors.forEach(function(t){return t.list=[]});var t=Math.floor(students.length/mentors.length);students.length%mentors.length!==0&&t++;var s=[];mentors.forEach(function(t){t.wishList&&t.wishList.forEach(function(e){s.push([e.synergy,t.id,e.studentId])})}),s.sort(function(t,s){return s[0]-t[0]});for(var e=function(){var e=s.shift();e&&(getElemOfObject(mentors,e[1]).list.push(e[2]),s=s.filter(function(s){return s[2]===e[2]||getElemOfObject(mentors,s[1]).list.length>=t?void 0:s}))};s.length;)e()}function clearAll(){students=[],groups=[],tasks=[],mentors=[],students.counter=groups.counter=tasks.counter=mentors.counter=0}$(document).ready(function(){renderApp(),$(document).on("click",".students__title",onStudentTitleClick),$(document).on("click",".mentors__title",onMentorTitleClick),$(document).on("mousedown",onMouseDown),$(".distribution__button").click(onDistributionButtonClick),$(".options__json-export").click(exportJSON),$(".options__set-random").click(setRandPriority),$(".options__clear-all").click(onClearAllClick),$(".students").on("click",".students__delete-button",onStudentDeleteClick),$(".students").on("click",".students__add-to-group-button",onStudentAddToGroupClick),$(".students").on("click",".students__expel-button",onStudentExpelClick),$(".students").on("click",".students__group-menu-button",onAddGroupMenuClick),$(".students").on("click",".students__new-group",onAddGroupBtnClick),$(".students").on("click",".students__add-button",onStudentAddClick),$(".students").on("click",".students__add-task-button",onTaskAddClick),$(".students").on("click",".students__delete-group-button",onGroupDeleteClick),$(".students").on("click",".students__expel-all-button",onGroupExpellAllClick),$(".students").on("click",".groups__item-name span",onGroupEditClick),$(".students").on("click",".students__name span",onStudentEditClick),$(".students__input").keypress(function(t){return 13==t.which?onStudentAddClick():!0}),$(".students").on("click",".students__show-wishlist-button",onShowWishListClick),$(".mentors").on("click",".mentors__add-button",onMentorAddClick),$(".mentors").on("click",".mentors__name span",onMentorEditClick),$(".mentors").on("click",".mentors__delete-button",onMentorDeleteClick),$(".mentors__input").keypress(function(t){return 13==t.which?onMentorAddClick():!0}),$(".mentors").on("click",".mentors__show-wishlist-button",onShowWishListClick),$(".wishlist").on("mouseenter",".wishlist__priority i",onHoverRating),$(".wishlist").on("click",".wishlist__priority i",onRatingClick),$(".wishlist").on("mouseleave",".wishlist__priority",onLeavingRating),$(".tasks").on("click",".tasks__task-delete-button",onTaskDeleteClick),$(".tasks").on("click",".tasks__task-item-name",onTaskEditClick),$(".tasks").on("click",".tasks__task-item-details",onTaskDetailEditClick),$(".tasks").on("mouseenter",".tasks__task-item-rating i",onHoverRating),$(".tasks").on("click",".tasks__task-item-rating i",onRatingClick),$(".tasks").on("mouseleave",".tasks__task-item-rating",onLeavingRating)});var PATH="dist/data/data.json",data=readFromJson(PATH),students=data.students,groups=data.groups,tasks=data.tasks,mentors=data.mentors;students.counter=students.length,groups.counter=groups.length,tasks.counter=tasks.length,mentors.counter=mentors.length;